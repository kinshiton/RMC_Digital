"""
AIè§†è§‰å¼‚å¸¸æ£€æµ‹ç®¡ç†é¢æ¿ - iOSé£æ ¼
ç”¨äºè®­ç»ƒæ•°æ®ç®¡ç†ã€å®æ—¶ç›‘æ§ã€å‘Šè­¦æŸ¥çœ‹
"""
import streamlit as st
import pandas as pd
from pathlib import Path
import sys
import cv2
from PIL import Image
import sqlite3
from datetime import datetime

# æ·»åŠ é¡¹ç›®æ ¹ç›®å½•åˆ°è·¯å¾„
sys.path.insert(0, str(Path(__file__).parent.parent))

from modules.vision_ai.behavior_detector import BehaviorDetector
from modules.vision_ai.camera_manager import CameraManager

# å¯¼å…¥iOSé£æ ¼
sys.path.insert(0, str(Path(__file__).parent))
from ios_style import apply_ios_style, ios_card, ios_badge, ios_divider, IOS_ICONS, IOS_COLORS

# é¡µé¢é…ç½®
st.set_page_config(
    page_title="ğŸ“· AIè§†è§‰æ£€æµ‹",
    page_icon="ğŸ“·",
    layout="wide"
)

# åº”ç”¨iOSé£æ ¼
apply_ios_style()

# æ ‡é¢˜
st.markdown(f"""
<div style="text-align: center; padding: 2rem 0 1rem 0;">
    <h1 style="font-size: 3rem; margin: 0; background: linear-gradient(135deg, #007AFF 0%, #5856D6 100%); 
               -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 700;">
        {IOS_ICONS['camera']} AIè§†è§‰å¼‚å¸¸æ£€æµ‹ç³»ç»Ÿ
    </h1>
    <p style="color: #000000; margin-top: 0.5rem; font-size: 1.1rem; font-weight: 500;">
        AI-Powered Visual Anomaly Detection System
    </p>
</div>
""", unsafe_allow_html=True)

# åˆå§‹åŒ–æ£€æµ‹å™¨ï¼ˆç§»é™¤ç¼“å­˜é¿å…æ›´æ–°é—®é¢˜ï¼‰
def get_detector():
    return BehaviorDetector()

def get_camera_manager():
    return CameraManager()

# æ¯æ¬¡é‡æ–°åˆ›å»ºï¼Œç¡®ä¿ä½¿ç”¨æœ€æ–°ä»£ç 
detector = get_detector()
camera_mgr = get_camera_manager()

# ä¾§è¾¹æ å¯¼èˆª - iOSé£æ ¼
st.sidebar.markdown(f"""
<div style="text-align: center; padding: 1.5rem 0 1rem 0;">
    <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">{IOS_ICONS['camera']}</div>
    <h1 style="margin: 0; font-size: 1.5rem; color: #000000; font-weight: 600;">AIè§†è§‰æ£€æµ‹</h1>
</div>
""", unsafe_allow_html=True)

page = st.sidebar.radio(
    "é€‰æ‹©åŠŸèƒ½æ¨¡å—",
    [
        f"{IOS_ICONS['camera']} è®­ç»ƒæ•°æ®ç®¡ç†",
        f"{IOS_ICONS['star']} è‡ªå®šä¹‰è¡Œä¸ºç±»å‹",
        f"{IOS_ICONS['device']} æ‘„åƒå¤´ç®¡ç†",
        f"{IOS_ICONS['eye']} è§†é¢‘åˆ†æ",
        f"{IOS_ICONS['alarm']} å®æ—¶å‘Šè­¦",
        f"{IOS_ICONS['chart']} ç»Ÿè®¡åˆ†æ",
        f"{IOS_ICONS['settings']} æ¨¡å‹è®¾ç½®"
    ]
)


# ========== é¡µé¢1ï¼šè®­ç»ƒæ•°æ®ç®¡ç† ==========

if "è®­ç»ƒæ•°æ®ç®¡ç†" in page:
    ios_divider("è®­ç»ƒæ•°æ®ç®¡ç†")
    st.header("ğŸ“¸ è®­ç»ƒæ•°æ®ç®¡ç†")
    st.markdown("ä¸Šä¼ ä¸åŒç±»å‹çš„è¡Œä¸º**å›¾ç‰‡æˆ–è§†é¢‘**ï¼Œè®­ç»ƒAIæ¨¡å‹è¯†åˆ«å¼‚å¸¸")
    
    tabs = st.tabs(["ğŸ“ ä¸Šä¼ å›¾ç‰‡", "ğŸ¬ ä¸Šä¼ è§†é¢‘", "ğŸ“Š æŸ¥çœ‹è®­ç»ƒæ•°æ®"])
    
    # è·å–æ‰€æœ‰è¡Œä¸ºç±»å‹
    all_behaviors = detector.get_all_behaviors()
    behavior_options = [(b['code'], f"{b['name']} {'ğŸ”§' if b.get('custom') else ''}") for b in all_behaviors]
    
    # Tab 1: ä¸Šä¼ è®­ç»ƒå›¾ç‰‡
    with tabs[0]:
        st.subheader("ğŸ“¤ ä¸Šä¼ è®­ç»ƒå›¾ç‰‡")
        
        col1, col2 = st.columns(2)
        
        with col1:
            behavior_type = st.selectbox(
                "é€‰æ‹©è¡Œä¸ºç±»å‹*",
                behavior_options,
                format_func=lambda x: x[1],
                help="ğŸ”§ è¡¨ç¤ºè‡ªå®šä¹‰ç±»å‹"
            )
        
        with col2:
            st.info(f"""
            **ä¸Šä¼ æŒ‡å—ï¼š**
            - æ”¯æŒæ ¼å¼ï¼šJPG, PNG, BMP
            - å»ºè®®æ¯ç§è¡Œä¸ºè‡³å°‘50å¼ å›¾ç‰‡
            - å›¾ç‰‡åº”åŒ…å«æ¸…æ™°çš„äººç‰©åŠ¨ä½œ
            """)
        
        # æ–¹å¼1ï¼šæ‰¹é‡ä¸Šä¼ æ–‡ä»¶
        st.markdown("### æ–¹å¼1ï¼šä¸Šä¼ å›¾ç‰‡æ–‡ä»¶")
        uploaded_files = st.file_uploader(
            "é€‰æ‹©å›¾ç‰‡ï¼ˆå¯å¤šé€‰ï¼‰",
            type=['jpg', 'jpeg', 'png', 'bmp'],
            accept_multiple_files=True
        )
        
        if uploaded_files and st.button("ğŸ“¥ å¼€å§‹å¯¼å…¥"):
            # ä¿å­˜ä¸Šä¼ çš„æ–‡ä»¶
            save_dir = Path(f"data/training/{behavior_type[0]}")
            save_dir.mkdir(parents=True, exist_ok=True)
            
            progress_bar = st.progress(0)
            status_text = st.empty()
            
            for i, uploaded_file in enumerate(uploaded_files):
                # ä¿å­˜æ–‡ä»¶
                file_path = save_dir / uploaded_file.name
                with open(file_path, 'wb') as f:
                    f.write(uploaded_file.getbuffer())
                
                progress = (i + 1) / len(uploaded_files)
                progress_bar.progress(progress)
                status_text.text(f"å·²ä¿å­˜ {i+1}/{len(uploaded_files)} å¼ å›¾ç‰‡")
            
            # å¯¼å…¥åˆ°æ•°æ®åº“
            result = detector.import_training_images(str(save_dir), behavior_type[0])
            
            st.success(f"âœ… æˆåŠŸå¯¼å…¥ {result['imported_count']} å¼ å›¾ç‰‡ï¼")
        
        # æ–¹å¼2ï¼šæŒ‡å®šæ–‡ä»¶å¤¹è·¯å¾„
        st.markdown("### æ–¹å¼2ï¼šä»æ–‡ä»¶å¤¹å¯¼å…¥")
        
        col1, col2 = st.columns([3, 1])
        with col1:
            folder_path = st.text_input(
                "è¾“å…¥æ–‡ä»¶å¤¹è·¯å¾„",
                placeholder="ä¾‹å¦‚ï¼š/Users/yourname/Pictures/normal_swipe"
            )
        with col2:
            if st.button("ğŸ“‚ å¯¼å…¥æ–‡ä»¶å¤¹"):
                if folder_path:
                    with st.spinner("æ­£åœ¨å¯¼å…¥..."):
                        result = detector.import_training_images(folder_path, behavior_type[0])
                    
                    if result['status'] == 'success':
                        st.success(f"âœ… æˆåŠŸå¯¼å…¥ {result['imported_count']}/{result['total_files']} å¼ å›¾ç‰‡ï¼")
                    else:
                        st.error(f"âŒ å¯¼å…¥å¤±è´¥ï¼š{result.get('message', 'æœªçŸ¥é”™è¯¯')}")
    
    # Tab 2: ä¸Šä¼ è§†é¢‘
    with tabs[1]:
        st.subheader("ğŸ¬ ä¸Šä¼ è®­ç»ƒè§†é¢‘")
        st.markdown("**è§†é¢‘æ›´é€‚åˆè¯†åˆ«åŠ¨æ€è¡Œä¸ºï¼** ç³»ç»Ÿä¼šè‡ªåŠ¨æå–å…³é”®å¸§ç”¨äºè®­ç»ƒ")
        
        col1, col2 = st.columns(2)
        
        with col1:
            video_behavior_type = st.selectbox(
                "é€‰æ‹©è¡Œä¸ºç±»å‹*",
                behavior_options,
                format_func=lambda x: x[1],
                help="ğŸ”§ è¡¨ç¤ºè‡ªå®šä¹‰ç±»å‹",
                key="video_behavior"
            )
        
        with col2:
            extract_fps = st.slider(
                "æå–å¸§ç‡ï¼ˆæ¯ç§’æå–å¸§æ•°ï¼‰",
                1, 10, 2,
                help="å¸§ç‡è¶Šé«˜ï¼Œæå–çš„è®­ç»ƒå›¾ç‰‡è¶Šå¤šï¼Œä½†å¤„ç†æ—¶é—´æ›´é•¿"
            )
        
        st.info(f"""
        **è§†é¢‘ä¸Šä¼ æŒ‡å—ï¼š**
        - æ”¯æŒæ ¼å¼ï¼šMP4, AVI, MOV, MKV, GIF
        - å»ºè®®è§†é¢‘æ—¶é•¿ï¼š3-30ç§’
        - åŒ…å«å®Œæ•´çš„åŠ¨ä½œè¿‡ç¨‹ï¼ˆå¦‚å®Œæ•´çš„å°¾éšè¿‡ç¨‹ï¼‰
        - ç³»ç»Ÿä¼šè‡ªåŠ¨æå–å…³é”®å¸§ä¿å­˜ä¸ºå›¾ç‰‡
        """)
        
        # æ–¹å¼1ï¼šä¸Šä¼ è§†é¢‘æ–‡ä»¶
        st.markdown("### æ–¹å¼1ï¼šä¸Šä¼ è§†é¢‘æ–‡ä»¶")
        uploaded_videos = st.file_uploader(
            "é€‰æ‹©è§†é¢‘ï¼ˆå¯å¤šé€‰ï¼‰",
            type=['mp4', 'avi', 'mov', 'mkv', 'gif'],
            accept_multiple_files=True,
            key="video_uploader"
        )
        
        if uploaded_videos and st.button("ğŸ¬ å¼€å§‹å¤„ç†è§†é¢‘", key="process_videos"):
            progress_bar = st.progress(0)
            status_text = st.empty()
            total_frames = 0
            
            for i, uploaded_video in enumerate(uploaded_videos):
                status_text.text(f"æ­£åœ¨å¤„ç† {uploaded_video.name}...")
                
                # ä¿å­˜è§†é¢‘
                video_dir = Path("data/training/videos") / video_behavior_type[0]
                video_dir.mkdir(parents=True, exist_ok=True)
                video_path = video_dir / uploaded_video.name
                
                with open(video_path, 'wb') as f:
                    f.write(uploaded_video.getbuffer())
                
                # æå–å¸§
                result = detector.import_training_videos(
                    str(video_path),
                    video_behavior_type[0],
                    extract_fps=extract_fps
                )
                
                if result['status'] == 'success':
                    total_frames += result['frames_extracted']
                    st.success(f"âœ… {uploaded_video.name}: æå– {result['frames_extracted']} å¸§ (æ—¶é•¿ {result['video_duration']:.1f}ç§’)")
                else:
                    st.error(f"âŒ {uploaded_video.name}: {result.get('message')}")
                
                progress = (i + 1) / len(uploaded_videos)
                progress_bar.progress(progress)
            
            st.success(f"ğŸ‰ è§†é¢‘å¤„ç†å®Œæˆï¼å…±æå– {total_frames} å¸§è®­ç»ƒæ•°æ®")
        
        # æ–¹å¼2ï¼šæŒ‡å®šè§†é¢‘è·¯å¾„
        st.markdown("### æ–¹å¼2ï¼šä»æ–‡ä»¶å¤¹å¯¼å…¥è§†é¢‘")
        
        col1, col2 = st.columns([3, 1])
        with col1:
            video_folder_path = st.text_input(
                "è¾“å…¥è§†é¢‘æ–‡ä»¶å¤¹è·¯å¾„",
                placeholder="ä¾‹å¦‚ï¼š/Users/yourname/Videos/force_door",
                key="video_folder"
            )
        with col2:
            if st.button("ğŸ“‚ æ‰¹é‡å¤„ç†è§†é¢‘", key="batch_process"):
                if video_folder_path:
                    video_path = Path(video_folder_path)
                    if video_path.exists():
                        video_files = list(video_path.glob("*.mp4")) + \
                                    list(video_path.glob("*.avi")) + \
                                    list(video_path.glob("*.mov"))
                        
                        if video_files:
                            progress_bar = st.progress(0)
                            total_frames = 0
                            
                            for i, vf in enumerate(video_files):
                                result = detector.import_training_videos(
                                    str(vf),
                                    video_behavior_type[0],
                                    extract_fps=extract_fps
                                )
                                
                                if result['status'] == 'success':
                                    total_frames += result['frames_extracted']
                                
                                progress = (i + 1) / len(video_files)
                                progress_bar.progress(progress)
                            
                            st.success(f"âœ… å¤„ç† {len(video_files)} ä¸ªè§†é¢‘ï¼Œæå– {total_frames} å¸§")
                        else:
                            st.warning("æœªæ‰¾åˆ°è§†é¢‘æ–‡ä»¶")
                    else:
                        st.error("æ–‡ä»¶å¤¹ä¸å­˜åœ¨")
    
    # Tab 3: æŸ¥çœ‹è®­ç»ƒæ•°æ®
    with tabs[2]:
        st.subheader("ğŸ“Š è®­ç»ƒæ•°æ®ç»Ÿè®¡")
        
        stats = detector.get_training_stats()
        
        col1, col2, col3 = st.columns(3)
        
        behavior_names = {
            'normal_swipe': 'âœ… æ­£å¸¸åˆ·å¡',
            'force_door': 'âš ï¸ å¼ºè¡Œæ‹‰é—¨',
            'block_door': 'ğŸšª æŠµé—¨åŠ¨ä½œ',
            'tailgating': 'ğŸ‘¥ å°¾éšä»–äºº',
            'loitering': 'ğŸš¶ å¾˜å¾Š',
            'unknown': 'â“ æœªçŸ¥è¡Œä¸º'
        }
        
        for idx, (behavior_type, count) in enumerate(stats.items()):
            col = [col1, col2, col3][idx % 3]
            with col:
                st.metric(
                    behavior_names.get(behavior_type, behavior_type),
                    f"{count} å¼ "
                )
        
        # æ•°æ®å‡†å¤‡åº¦è¯„ä¼°
        st.markdown("### ğŸ¯ æ•°æ®å‡†å¤‡åº¦è¯„ä¼°")
        
        total_images = sum(stats.values())
        min_required = 50  # æ¯ç±»è‡³å°‘50å¼ 
        
        if total_images == 0:
            st.warning("âš ï¸ è¿˜æ²¡æœ‰è®­ç»ƒæ•°æ®ï¼Œè¯·å…ˆä¸Šä¼ å›¾ç‰‡")
        elif total_images < min_required * 4:
            st.info(f"ğŸ“ å»ºè®®æ¯ç§è¡Œä¸ºè‡³å°‘{min_required}å¼ å›¾ç‰‡ä»¥è·å¾—æ›´å¥½çš„è¯†åˆ«æ•ˆæœ")
        else:
            st.success("âœ… è®­ç»ƒæ•°æ®å……è¶³ï¼Œå¯ä»¥å¼€å§‹è®­ç»ƒæ¨¡å‹")
            
            if st.button("ğŸš€ å¼€å§‹è®­ç»ƒæ¨¡å‹ (å³å°†ä¸Šçº¿)"):
                st.info("æ·±åº¦å­¦ä¹ æ¨¡å‹è®­ç»ƒåŠŸèƒ½å³å°†ä¸Šçº¿ï¼Œç›®å‰ä½¿ç”¨åŸºäºè§„åˆ™çš„æ£€æµ‹")


# ========== é¡µé¢2ï¼šè‡ªå®šä¹‰è¡Œä¸ºç±»å‹ ==========

elif page == "ğŸ¯ è‡ªå®šä¹‰è¡Œä¸ºç±»å‹":
    st.header("ğŸ¯ è‡ªå®šä¹‰è¡Œä¸ºç±»å‹ç®¡ç†")
    st.markdown("**æ·»åŠ è‡ªå·±éœ€è¦è¯†åˆ«çš„è¡Œä¸ºç±»å‹**ï¼Œä¸å±€é™äºé¢„è®¾çš„å‡ ç§")
    
    tabs = st.tabs(["â• æ·»åŠ æ–°ç±»å‹", "ğŸ“‹ å·²æœ‰ç±»å‹"])
    
    # Tab 1: æ·»åŠ æ–°ç±»å‹
    with tabs[0]:
        st.subheader("â• æ·»åŠ æ–°çš„è¡Œä¸ºç±»å‹")
        
        with st.form("add_behavior_form"):
            col1, col2 = st.columns(2)
            
            with col1:
                behavior_code = st.text_input(
                    "è¡Œä¸ºä»£ç *ï¼ˆè‹±æ–‡ï¼Œç”¨ä¸‹åˆ’çº¿ï¼‰",
                    placeholder="ä¾‹å¦‚ï¼šrunning_in_corridor",
                    help="ä½¿ç”¨è‹±æ–‡å’Œä¸‹åˆ’çº¿ï¼Œå¦‚ï¼šsmoking_in_area"
                )
                
                alert_level = st.selectbox(
                    "å‘Šè­¦çº§åˆ«",
                    [("low", "ğŸŸ¢ ä½"), ("medium", "ğŸŸ¡ ä¸­"), ("high", "ğŸŸ  é«˜"), ("critical", "ğŸ”´ ä¸¥é‡")],
                    index=1,
                    format_func=lambda x: x[1]
                )
            
            with col2:
                behavior_name = st.text_input(
                    "è¡Œä¸ºåç§°*ï¼ˆä¸­æ–‡ï¼‰",
                    placeholder="ä¾‹å¦‚ï¼šèµ°å»Šå¥”è·‘",
                    help="ç”¨äºæ˜¾ç¤ºçš„ä¸­æ–‡åç§°"
                )
                
                color = st.color_picker(
                    "æ˜¾ç¤ºé¢œè‰²",
                    value="#FFA500",
                    help="åœ¨ç•Œé¢ä¸­æ˜¾ç¤ºçš„é¢œè‰²"
                )
            
            description = st.text_area(
                "è¡Œä¸ºæè¿°",
                placeholder="è¯¦ç»†æè¿°è¿™ç§è¡Œä¸ºçš„ç‰¹å¾...",
                height=100
            )
            
            submitted = st.form_submit_button("âœ… æ·»åŠ è¡Œä¸ºç±»å‹", use_container_width=True)
            
            if submitted and behavior_code and behavior_name:
                result = detector.add_custom_behavior(
                    behavior_code=behavior_code,
                    behavior_name=behavior_name,
                    description=description,
                    alert_level=alert_level[0],
                    color=color
                )
                
                if result['status'] == 'success':
                    st.success(f"âœ… {result['message']}")
                    st.info("ğŸ’¡ ç°åœ¨å¯ä»¥åœ¨ã€Œè®­ç»ƒæ•°æ®ç®¡ç†ã€ä¸­ä¸Šä¼ è¿™ç§è¡Œä¸ºçš„è§†é¢‘æˆ–å›¾ç‰‡äº†ï¼")
                else:
                    st.error(f"âŒ {result['message']}")
        
        # ç¤ºä¾‹å‚è€ƒ
        st.markdown("---")
        st.subheader("ğŸ’¡ ç¤ºä¾‹å‚è€ƒ")
        st.markdown("""
        **å¸¸è§çš„è‡ªå®šä¹‰è¡Œä¸ºç±»å‹ï¼š**
        
        | è¡Œä¸ºä»£ç  | è¡Œä¸ºåç§° | æè¿° | å‘Šè­¦çº§åˆ« |
        |---------|---------|------|---------|
        | `running_in_corridor` | èµ°å»Šå¥”è·‘ | åœ¨èµ°å»ŠåŒºåŸŸå¥”è·‘ | ä¸­ |
        | `smoking_indoors` | å®¤å†…å¸çƒŸ | åœ¨ç¦çƒŸåŒºåŸŸå¸çƒŸ | é«˜ |
        | `climbing_fence` | ç¿»è¶Šå›´æ  | è¯•å›¾ç¿»è¶Šå›´æ  | ä¸¥é‡ |
        | `package_left_unattended` | å¯ç–‘ç‰©å“é—ç•™ | é•¿æ—¶é—´é—ç•™çš„ç‰©å“ | é«˜ |
        | `unauthorized_parking` | éæ³•åœè½¦ | åœ¨ç¦æ­¢åŒºåŸŸåœè½¦ | ä¸­ |
        | `gathering_at_door` | é—¨å£èšé›† | å¤šäººåœ¨é—¨å£èšé›† | ä½ |
        | `phone_while_driving` | é©¾é©¶ä½¿ç”¨æ‰‹æœº | å¼€è½¦æ—¶ä½¿ç”¨æ‰‹æœº | é«˜ |
        """)
    
    # Tab 2: å·²æœ‰ç±»å‹
    with tabs[1]:
        st.subheader("ğŸ“‹ æ‰€æœ‰è¡Œä¸ºç±»å‹")
        
        all_behaviors = detector.get_all_behaviors()
        
        if not all_behaviors:
            st.info("è¿˜æ²¡æœ‰è‡ªå®šä¹‰è¡Œä¸ºç±»å‹")
        else:
            # åˆ†ç»„æ˜¾ç¤º
            st.markdown("### ğŸ”§ è‡ªå®šä¹‰ç±»å‹")
            custom_behaviors = [b for b in all_behaviors if b.get('custom', False)]
            
            if custom_behaviors:
                for behavior in custom_behaviors:
                    with st.expander(f"{behavior['name']} ({behavior['code']})"):
                        col1, col2, col3 = st.columns(3)
                        
                        with col1:
                            st.write(f"**ä»£ç :** `{behavior['code']}`")
                            st.write(f"**åç§°:** {behavior['name']}")
                        
                        with col2:
                            level_emoji = {"low": "ğŸŸ¢", "medium": "ğŸŸ¡", "high": "ğŸŸ ", "critical": "ğŸ”´"}
                            st.write(f"**å‘Šè­¦çº§åˆ«:** {level_emoji.get(behavior['alert_level'], 'âšª')} {behavior['alert_level']}")
                            if behavior.get('color'):
                                st.color_picker(
                                    "é¢œè‰²",
                                    value=behavior['color'],
                                    disabled=True,
                                    key=f"color_{behavior['code']}"
                                )
                        
                        with col3:
                            if behavior.get('description'):
                                st.write(f"**æè¿°:** {behavior['description']}")
            else:
                st.info("è¿˜æ²¡æœ‰è‡ªå®šä¹‰ç±»å‹ï¼Œåœ¨ä¸Šæ–¹æ·»åŠ å§ï¼")
            
            st.markdown("---")
            st.markdown("### ğŸ“Œ é¢„è®¾ç±»å‹")
            preset_behaviors = [b for b in all_behaviors if not b.get('custom', False)]
            
            for behavior in preset_behaviors:
                st.write(f"â€¢ **{behavior['name']}** (`{behavior['code']}`)")


# ========== é¡µé¢3ï¼šæ‘„åƒå¤´ç®¡ç† ==========

elif page == "ğŸ“¹ æ‘„åƒå¤´ç®¡ç†":
    st.header("ğŸ“¹ æ‘„åƒå¤´ä¸å½•åƒç³»ç»Ÿç®¡ç†")
    st.markdown("**é…ç½®å®‰è®¯å£«(Axis)æ‘„åƒå¤´å’ŒExacqVisionå½•åƒç³»ç»Ÿ**")
    
    tabs = st.tabs(["ğŸ“¹ æ‘„åƒå¤´é…ç½®", "ğŸ“¼ ExacqVisionæœåŠ¡å™¨", "ğŸ” æŸ¥çœ‹è®¾å¤‡"])
    
    # Tab 1: æ‘„åƒå¤´é…ç½®
    with tabs[0]:
        st.subheader("â• æ·»åŠ æ‘„åƒå¤´")
        
        camera_type_option = st.radio(
            "æ‘„åƒå¤´ç±»å‹",
            ["å®‰è®¯å£«(Axis)", "é€šç”¨RTSPæ‘„åƒå¤´"],
            horizontal=True
        )
        
        if camera_type_option == "å®‰è®¯å£«(Axis)":
            with st.form("add_axis_camera"):
                col1, col2 = st.columns(2)
                
                with col1:
                    camera_name = st.text_input(
                        "æ‘„åƒå¤´åç§°*",
                        placeholder="ä¾‹å¦‚ï¼šAåŒºé—¨ç¦æ‘„åƒå¤´"
                    )
                    ip_address = st.text_input(
                        "IPåœ°å€*",
                        placeholder="ä¾‹å¦‚ï¼š192.168.1.100"
                    )
                    port = st.number_input(
                        "ç«¯å£",
                        value=80,
                        min_value=1,
                        max_value=65535
                    )
                
                with col2:
                    location = st.text_input(
                        "å®‰è£…ä½ç½®",
                        placeholder="ä¾‹å¦‚ï¼šAåŒºå…¥å£"
                    )
                    username = st.text_input(
                        "ç”¨æˆ·å",
                        placeholder="admin"
                    )
                    password = st.text_input(
                        "å¯†ç ",
                        type="password"
                    )
                
                submitted = st.form_submit_button("âœ… æ·»åŠ æ‘„åƒå¤´", use_container_width=True)
                
                if submitted and camera_name and ip_address:
                    result = camera_mgr.add_axis_camera(
                        name=camera_name,
                        ip_address=ip_address,
                        username=username,
                        password=password,
                        port=port,
                        location=location
                    )
                    
                    if result['status'] == 'success':
                        st.success(f"âœ… {result['message']}")
                        st.code(f"RTSP URL: {result['rtsp_url']}", language="text")
                    else:
                        st.error(f"âŒ {result['message']}")
        
        else:  # é€šç”¨RTSPæ‘„åƒå¤´
            with st.form("add_rtsp_camera"):
                camera_name = st.text_input(
                    "æ‘„åƒå¤´åç§°*",
                    placeholder="ä¾‹å¦‚ï¼šBåŒºç›‘æ§æ‘„åƒå¤´"
                )
                
                rtsp_url = st.text_input(
                    "RTSPæµåœ°å€*",
                    placeholder="rtsp://username:password@192.168.1.101:554/stream"
                )
                
                location = st.text_input(
                    "å®‰è£…ä½ç½®",
                    placeholder="ä¾‹å¦‚ï¼šBåŒºå…¥å£"
                )
                
                submitted = st.form_submit_button("âœ… æ·»åŠ æ‘„åƒå¤´", use_container_width=True)
                
                if submitted and camera_name and rtsp_url:
                    result = camera_mgr.add_generic_camera(
                        name=camera_name,
                        rtsp_url=rtsp_url,
                        location=location
                    )
                    
                    if result['status'] == 'success':
                        st.success(f"âœ… {result['message']}")
                    else:
                        st.error(f"âŒ {result['message']}")
    
    # Tab 2: ExacqVisionæœåŠ¡å™¨
    with tabs[1]:
        st.subheader("â• æ·»åŠ ExacqVisionå½•åƒæœåŠ¡å™¨")
        
        st.info("""
        **ExacqVisioné›†æˆè¯´æ˜ï¼š**
        - ExacqVisionæ˜¯ä¸“ä¸šçš„è§†é¢‘ç®¡ç†ç³»ç»Ÿ(VMS)
        - é…ç½®åå¯ä»¥ç›´æ¥è®¿é—®å†å²å½•åƒ
        - æ”¯æŒå¯¼å‡ºå½•åƒç‰‡æ®µç”¨äºAIåˆ†æ
        """)
        
        with st.form("add_exacqvision"):
            col1, col2 = st.columns(2)
            
            with col1:
                server_name = st.text_input(
                    "æœåŠ¡å™¨åç§°*",
                    placeholder="ä¾‹å¦‚ï¼šä¸»å½•åƒæœåŠ¡å™¨"
                )
                server_ip = st.text_input(
                    "æœåŠ¡å™¨IP*",
                    placeholder="ä¾‹å¦‚ï¼š192.168.1.200"
                )
            
            with col2:
                server_port = st.number_input(
                    "ç«¯å£",
                    value=80,
                    min_value=1,
                    max_value=65535
                )
                server_username = st.text_input(
                    "ç”¨æˆ·å*",
                    placeholder="admin"
                )
            
            server_password = st.text_input(
                "å¯†ç *",
                type="password"
            )
            
            submitted = st.form_submit_button("âœ… æ·»åŠ æœåŠ¡å™¨", use_container_width=True)
            
            if submitted and server_name and server_ip and server_username and server_password:
                result = camera_mgr.add_exacqvision_server(
                    server_name=server_name,
                    server_ip=server_ip,
                    username=server_username,
                    password=server_password,
                    port=server_port
                )
                
                if result['status'] == 'success':
                    st.success(f"âœ… {result['message']}")
                    st.info("ğŸ’¡ ç°åœ¨å¯ä»¥åœ¨ã€Œè§†é¢‘åˆ†æã€ä¸­é€‰æ‹©ä»ExacqVisionå¯¼å…¥å½•åƒ")
                else:
                    st.error(f"âŒ {result['message']}")
    
    # Tab 3: æŸ¥çœ‹è®¾å¤‡
    with tabs[2]:
        st.subheader("ğŸ“¹ å·²é…ç½®çš„æ‘„åƒå¤´")
        
        cameras = camera_mgr.get_all_cameras()
        
        if not cameras:
            st.info("è¿˜æ²¡æœ‰é…ç½®æ‘„åƒå¤´")
        else:
            for camera in cameras:
                with st.expander(f"ğŸ“¹ {camera['name']} ({camera['type']})"):
                    col1, col2, col3 = st.columns(3)
                    
                    with col1:
                        st.write(f"**åç§°:** {camera['name']}")
                        st.write(f"**ç±»å‹:** {camera['type']}")
                        if camera.get('ip'):
                            st.write(f"**IP:** {camera['ip']}")
                    
                    with col2:
                        if camera.get('location'):
                            st.write(f"**ä½ç½®:** {camera['location']}")
                        st.write(f"**çŠ¶æ€:** {'ğŸŸ¢ æ´»åŠ¨' if camera['status'] == 'active' else 'ğŸ”´ ç¦ç”¨'}")
                    
                    with col3:
                        if st.button("ğŸ”— æµ‹è¯•è¿æ¥", key=f"test_{camera['id']}"):
                            result = camera_mgr.test_camera_connection(camera['id'])
                            if result['status'] == 'success':
                                st.success(result['message'])
                            else:
                                st.error(result['message'])
                    
                    if camera.get('rtsp_url'):
                        st.code(f"RTSP URL: {camera['rtsp_url']}", language="text")
        
        st.markdown("---")
        st.subheader("ğŸ“¼ ExacqVisionæœåŠ¡å™¨")
        
        servers = camera_mgr.get_all_exacqvision_servers()
        
        if not servers:
            st.info("è¿˜æ²¡æœ‰é…ç½®ExacqVisionæœåŠ¡å™¨")
        else:
            for server in servers:
                with st.expander(f"ğŸ“¼ {server['name']}"):
                    col1, col2 = st.columns(2)
                    
                    with col1:
                        st.write(f"**åç§°:** {server['name']}")
                        st.write(f"**IP:** {server['ip']}")
                    
                    with col2:
                        st.write(f"**ç«¯å£:** {server['port']}")
                        st.write(f"**çŠ¶æ€:** {'ğŸŸ¢ æ´»åŠ¨' if server['status'] == 'active' else 'ğŸ”´ ç¦ç”¨'}")
                    
                    st.code(f"APIç«¯ç‚¹: {server['api_endpoint']}", language="text")


# ========== é¡µé¢4ï¼šè§†é¢‘åˆ†æ ==========

elif page == "ğŸ¬ è§†é¢‘åˆ†æ":
    st.header("ğŸ¬ è§†é¢‘å¼‚å¸¸åˆ†æ")
    st.markdown("ä¸Šä¼ è§†é¢‘æˆ–æŒ‡å®šè§†é¢‘æ–‡ä»¶ï¼Œè‡ªåŠ¨è¯†åˆ«å¼‚å¸¸è¡Œä¸º")
    
    analysis_mode = st.radio(
        "é€‰æ‹©åˆ†ææ¨¡å¼",
        ["ä¸Šä¼ è§†é¢‘æ–‡ä»¶", "æ‘„åƒå¤´å®æ—¶åˆ†æ"]
    )
    
    if analysis_mode == "ä¸Šä¼ è§†é¢‘æ–‡ä»¶":
        uploaded_video = st.file_uploader("é€‰æ‹©è§†é¢‘æ–‡ä»¶", type=['mp4', 'avi', 'mov'])
        
        col1, col2 = st.columns(2)
        with col1:
            frame_skip = st.slider("è·³å¸§æ•°ï¼ˆæé«˜åˆ†æé€Ÿåº¦ï¼‰", 1, 30, 5)
        with col2:
            confidence_threshold = st.slider("å‘Šè­¦ç½®ä¿¡åº¦é˜ˆå€¼", 0.0, 1.0, 0.7)
        
        if uploaded_video and st.button("ğŸ” å¼€å§‹åˆ†æ"):
            # ä¿å­˜ä¸Šä¼ çš„è§†é¢‘
            video_path = Path("data/vision_ai/uploads") / uploaded_video.name
            video_path.parent.mkdir(parents=True, exist_ok=True)
            
            with open(video_path, 'wb') as f:
                f.write(uploaded_video.getbuffer())
            
            st.info(f"è§†é¢‘å·²ä¿å­˜: {video_path}")
            
            # åˆ›å»ºå‘Šè­¦å®¹å™¨
            alert_container = st.empty()
            alerts_list = []
            
            def on_alert(alert):
                alerts_list.append(alert)
                with alert_container.container():
                    st.warning(f"ğŸš¨ {alert['message']}")
                    st.write(f"æ—¶é—´: {alert['timestamp']}")
                    if Path(alert['image_path']).exists():
                        st.image(alert['image_path'], caption="å‘Šè­¦æˆªå›¾", width=400)
            
            # åˆ†æè§†é¢‘
            with st.spinner("æ­£åœ¨åˆ†æè§†é¢‘..."):
                try:
                    detector.analyze_video_stream(
                        str(video_path),
                        alert_callback=on_alert,
                        frame_skip=frame_skip
                    )
                    st.success(f"âœ… åˆ†æå®Œæˆï¼å…±æ£€æµ‹åˆ° {len(alerts_list)} ä¸ªå¼‚å¸¸")
                except Exception as e:
                    st.error(f"âŒ åˆ†æå¤±è´¥ï¼š{str(e)}")
    
    else:  # æ‘„åƒå¤´å®æ—¶åˆ†æ
        st.info("ğŸ“¹ æ‘„åƒå¤´å®æ—¶åˆ†æåŠŸèƒ½")
        
        camera_id = st.number_input("æ‘„åƒå¤´ID", 0, 10, 0)
        
        if st.button("ğŸ¥ å¯åŠ¨å®æ—¶ç›‘æ§"):
            st.warning("å®æ—¶ç›‘æ§åŠŸèƒ½éœ€è¦åœ¨åå°è¿è¡Œï¼Œè¯·æŸ¥çœ‹ç»ˆç«¯è¾“å‡º")
            st.code(f"""
# åœ¨ç»ˆç«¯è¿è¡Œä»¥ä¸‹å‘½ä»¤å¯åŠ¨å®æ—¶ç›‘æ§ï¼š
cd /Users/sven/Cursor_Project/RMC_Digital
source venv/bin/activate
python -c "
from modules.vision_ai.behavior_detector import BehaviorDetector
detector = BehaviorDetector()
detector.analyze_video_stream({camera_id})
"
            """, language="bash")


# ========== é¡µé¢3ï¼šå®æ—¶å‘Šè­¦ ==========

elif page == "ğŸš¨ å®æ—¶å‘Šè­¦":
    st.header("ğŸš¨ å®æ—¶å‘Šè­¦ç›‘æ§")
    
    # è‡ªåŠ¨åˆ·æ–°
    auto_refresh = st.checkbox("è‡ªåŠ¨åˆ·æ–°ï¼ˆæ¯10ç§’ï¼‰", value=True)
    
    if auto_refresh:
        st.write("â±ï¸ è‡ªåŠ¨åˆ·æ–°å·²å¯ç”¨")
        # æ³¨æ„ï¼šå®é™…éƒ¨ç½²æ—¶ä½¿ç”¨ st.experimental_rerun é…åˆå®šæ—¶å™¨
    
    # è·å–æœ€è¿‘å‘Šè­¦
    alerts = detector.get_recent_alerts(limit=20)
    
    if not alerts:
        st.info("æš‚æ— å‘Šè­¦è®°å½•")
    else:
        st.write(f"æœ€è¿‘ {len(alerts)} æ¡å‘Šè­¦ï¼š")
        
        for alert in alerts:
            with st.expander(f"ğŸš¨ {alert['message']} - {alert['timestamp']}"):
                col1, col2 = st.columns([2, 1])
                
                with col1:
                    if alert['image_path'] and Path(alert['image_path']).exists():
                        st.image(alert['image_path'], caption="å‘Šè­¦æˆªå›¾", use_container_width=True)
                    else:
                        st.warning("å›¾ç‰‡ä¸å­˜åœ¨")
                
                with col2:
                    st.markdown(f"""
                    **å‘Šè­¦è¯¦æƒ…**
                    - **ç±»å‹**: {alert['behavior_type']}
                    - **çŠ¶æ€**: {alert['status']}
                    - **æ—¶é—´**: {alert['timestamp']}
                    """)
                    
                    if alert['status'] == 'pending':
                        if st.button("âœ… å·²å¤„ç†", key=f"resolve_{alert['id']}"):
                            # æ›´æ–°çŠ¶æ€
                            conn = sqlite3.connect(detector.db_path)
                            cursor = conn.cursor()
                            cursor.execute("""
                                UPDATE alerts SET status = 'resolved' WHERE id = ?
                            """, (alert['id'],))
                            conn.commit()
                            conn.close()
                            st.success("çŠ¶æ€å·²æ›´æ–°")
                            st.rerun()


# ========== é¡µé¢4ï¼šç»Ÿè®¡åˆ†æ ==========

elif page == "ğŸ“Š ç»Ÿè®¡åˆ†æ":
    st.header("ğŸ“Š ç»Ÿè®¡åˆ†æ")
    
    col1, col2, col3, col4 = st.columns(4)
    
    # æŸ¥è¯¢ç»Ÿè®¡æ•°æ®
    conn = sqlite3.connect(detector.db_path)
    
    with col1:
        total_detections = pd.read_sql_query(
            "SELECT COUNT(*) as count FROM detection_results", conn
        ).iloc[0]['count']
        st.metric("æ€»æ£€æµ‹æ¬¡æ•°", total_detections)
    
    with col2:
        total_alerts = pd.read_sql_query(
            "SELECT COUNT(*) as count FROM alerts", conn
        ).iloc[0]['count']
        st.metric("æ€»å‘Šè­¦æ•°", total_alerts)
    
    with col3:
        pending_alerts = pd.read_sql_query(
            "SELECT COUNT(*) as count FROM alerts WHERE status = 'pending'", conn
        ).iloc[0]['count']
        st.metric("å¾…å¤„ç†å‘Šè­¦", pending_alerts)
    
    with col4:
        training_images = pd.read_sql_query(
            "SELECT COUNT(*) as count FROM training_images", conn
        ).iloc[0]['count']
        st.metric("è®­ç»ƒå›¾ç‰‡æ•°", training_images)
    
    # è¡Œä¸ºç±»å‹åˆ†å¸ƒ
    st.subheader("å¼‚å¸¸è¡Œä¸ºç±»å‹åˆ†å¸ƒ")
    
    df_behavior = pd.read_sql_query("""
        SELECT behavior_type, COUNT(*) as count
        FROM detection_results
        GROUP BY behavior_type
        ORDER BY count DESC
    """, conn)
    
    if not df_behavior.empty:
        st.bar_chart(df_behavior.set_index('behavior_type'))
    else:
        st.info("æš‚æ— æ£€æµ‹æ•°æ®")
    
    # æœ€è¿‘æ£€æµ‹è®°å½•
    st.subheader("æœ€è¿‘æ£€æµ‹è®°å½•")
    
    df_recent = pd.read_sql_query("""
        SELECT 
            video_source,
            frame_number,
            behavior_type,
            confidence,
            timestamp
        FROM detection_results
        ORDER BY timestamp DESC
        LIMIT 20
    """, conn)
    
    if not df_recent.empty:
        st.dataframe(df_recent, use_container_width=True)
    else:
        st.info("æš‚æ— æ£€æµ‹è®°å½•")
    
    conn.close()


# ========== é¡µé¢5ï¼šæ¨¡å‹è®¾ç½® ==========

elif page == "âš™ï¸ æ¨¡å‹è®¾ç½®":
    st.header("âš™ï¸ æ¨¡å‹è®¾ç½®")
    
    st.subheader("å½“å‰ä½¿ç”¨çš„æ£€æµ‹æ–¹æ³•")
    
    try:
        from ultralytics import YOLO
        st.success("âœ… YOLOv8 å·²å®‰è£…ï¼ˆæ¨èï¼‰")
        use_yolo = True
    except ImportError:
        st.warning("âš ï¸ YOLOv8 æœªå®‰è£…ï¼Œä½¿ç”¨OpenCV HOGæ£€æµ‹å™¨")
        use_yolo = False
        
        st.markdown("""
        **å®‰è£… YOLOv8 ä»¥è·å¾—æ›´å¥½çš„æ£€æµ‹æ•ˆæœï¼š**
        ```bash
        pip install ultralytics
        ```
        """)
    
    st.markdown("---")
    
    st.subheader("æ£€æµ‹å‚æ•°è°ƒæ•´")
    
    col1, col2 = st.columns(2)
    
    with col1:
        confidence_threshold = st.slider(
            "æ£€æµ‹ç½®ä¿¡åº¦é˜ˆå€¼",
            0.0, 1.0, 0.7,
            help="åªæœ‰ç½®ä¿¡åº¦é«˜äºæ­¤å€¼çš„æ£€æµ‹æ‰ä¼šè§¦å‘å‘Šè­¦"
        )
    
    with col2:
        frame_skip = st.slider(
            "è§†é¢‘è·³å¸§æ•°",
            1, 30, 5,
            help="è·³è¿‡çš„å¸§æ•°è¶Šå¤šï¼Œå¤„ç†é€Ÿåº¦è¶Šå¿«ï¼Œä½†å¯èƒ½é—æ¼çŸ­æš‚çš„å¼‚å¸¸"
        )
    
    st.info("ğŸ’¡ è¿™äº›å‚æ•°å°†åœ¨ä¸‹æ¬¡è§†é¢‘åˆ†ææ—¶ç”Ÿæ•ˆ")
    
    st.markdown("---")
    
    st.subheader("é«˜çº§åŠŸèƒ½ï¼ˆè§„åˆ’ä¸­ï¼‰")
    
    st.markdown("""
    ğŸš€ **å³å°†ä¸Šçº¿çš„åŠŸèƒ½ï¼š**
    
    1. **æ·±åº¦å­¦ä¹ æ¨¡å‹è®­ç»ƒ**
       - ä½¿ç”¨ä¸Šä¼ çš„è®­ç»ƒå›¾ç‰‡è®­ç»ƒè‡ªå®šä¹‰åˆ†ç±»æ¨¡å‹
       - æ”¯æŒè¿ç§»å­¦ä¹ ï¼Œæé«˜è¯†åˆ«å‡†ç¡®ç‡
    
    2. **å¤šæ‘„åƒå¤´è”åŠ¨**
       - åŒæ—¶ç›‘æ§å¤šä¸ªæ‘„åƒå¤´
       - è·¨æ‘„åƒå¤´è¿½è¸ªå¯ç–‘äººå‘˜
    
    3. **æ™ºèƒ½å‘Šè­¦ç­–ç•¥**
       - æ ¹æ®æ—¶é—´ã€åœ°ç‚¹è‡ªåŠ¨è°ƒæ•´å‘Šè­¦é˜ˆå€¼
       - å‡å°‘è¯¯æŠ¥ï¼Œæé«˜å‡†ç¡®æ€§
    
    4. **ä¸é—¨ç¦ç³»ç»Ÿé›†æˆ**
       - å…³è”åˆ·å¡è®°å½•ï¼Œè¯†åˆ«å¼‚å¸¸æ¨¡å¼
       - è‡ªåŠ¨ç”Ÿæˆè°ƒæŸ¥æŠ¥å‘Š
    """)


# ========== ä¾§è¾¹æ ä¿¡æ¯ ==========

st.sidebar.markdown("---")
st.sidebar.subheader("ğŸ’¡ ä½¿ç”¨æµç¨‹")
st.sidebar.markdown("""
**å¿«é€Ÿå¼€å§‹ï¼š**

1. **å‡†å¤‡æ•°æ®**
   - ä¸Šä¼ ä¸åŒè¡Œä¸ºçš„è®­ç»ƒå›¾ç‰‡
   - æ¯ç§è¡Œä¸ºå»ºè®®50+å¼ 

2. **æµ‹è¯•æ£€æµ‹**
   - ä¸Šä¼ æµ‹è¯•è§†é¢‘
   - æŸ¥çœ‹æ£€æµ‹æ•ˆæœ

3. **å®æ—¶ç›‘æ§**
   - è¿æ¥æ‘„åƒå¤´
   - å®æ—¶æ¥æ”¶å‘Šè­¦

4. **æŒç»­ä¼˜åŒ–**
   - æ ¹æ®åé¦ˆè°ƒæ•´å‚æ•°
   - è¡¥å……è®­ç»ƒæ•°æ®
""")

st.sidebar.markdown("---")
st.sidebar.subheader("ğŸ“š è¡Œä¸ºç±»å‹è¯´æ˜")
st.sidebar.markdown("""
- âœ… **æ­£å¸¸åˆ·å¡**: æ­£å¸¸åˆ·å¡è¿›é—¨
- âš ï¸ **å¼ºè¡Œæ‹‰é—¨**: æœªåˆ·å¡å¼ºè¡Œæ‹‰é—¨
- ğŸšª **æŠµé—¨**: ç”¨èº«ä½“æŠµä½é—¨
- ğŸ‘¥ **å°¾éš**: è·Ÿéšä»–äººè¿›å…¥
- ğŸš¶ **å¾˜å¾Š**: åœ¨é—¨ç¦åŒºåŸŸå¾˜å¾Š
""")

st.sidebar.markdown("---")
st.sidebar.caption("Â© 2025 RMC Digital æ™ºèƒ½å®‰é˜²ç³»ç»Ÿ")

