# 🎉 系统升级完成 - 新功能说明

## ✅ 本次升级内容

### 1. 📚 知识库支持多种格式

**新增功能：**
- ✅ 支持PDF、Word、PPT等文件上传
- ✅ 支持外部链接（网站、SharePoint等）
- ✅ 支持Power BI报表链接
- ✅ 支持Power Apps应用链接
- ✅ 支持图片附件

**使用方法：**
1. 打开知识库管理后台（http://localhost:8502）
2. 选择「添加知识」
3. 选择内容类型：
   - 📝 文本内容
   - 📎 文件上传
   - 🔗 外部链接
   - 📊 Power BI/Apps

---

### 2. 🎯 自定义行为类型

**新增功能：**
- ✅ 自由添加行为类型，不局限于预设
- ✅ 设置告警级别（低/中/高/严重）
- ✅ 自定义显示颜色
- ✅ 添加行为描述

**常见自定义类型示例：**
| 行为代码 | 行为名称 | 用途 |
|---------|---------|------|
| `running_in_corridor` | 走廊奔跑 | 检测走廊奔跑行为 |
| `smoking_indoors` | 室内吸烟 | 检测禁烟区吸烟 |
| `climbing_fence` | 翻越围栏 | 检测翻越行为 |
| `package_left_unattended` | 可疑物品遗留 | 检测遗留物品 |

**使用方法：**
1. 打开AI视觉检测（http://localhost:8503）
2. 点击「🎯 自定义行为类型」
3. 填写行为代码、名称、描述
4. 选择告警级别和颜色
5. 添加完成后，在训练数据管理中上传该行为的视频/图片

---

### 3. 🎬 支持视频格式训练

**新增功能：**
- ✅ 支持MP4、AVI、MOV、MKV、GIF格式
- ✅ 自动提取关键帧
- ✅ 可调整帧率（1-10帧/秒）
- ✅ 批量处理视频
- ✅ 显示处理进度

**为什么使用视频？**
- 动态行为需要时间序列数据
- 单张图片无法完整展示动作过程
- 视频包含运动轨迹信息
- 更适合识别"尾随"、"徘徊"等动态行为

**使用方法：**
1. 打开AI视觉检测（http://localhost:8503）
2. 选择「📸 训练数据管理」→「🎬 上传视频」
3. 选择行为类型
4. 调整提取帧率（推荐2-5帧/秒）
5. 上传视频文件或指定文件夹
6. 系统自动提取帧并保存

**提取效果：**
- 10秒视频 × 2帧/秒 = 20张训练图片
- 30秒视频 × 5帧/秒 = 150张训练图片

---

### 4. 📹 摄像头配置管理

**新增功能：**
- ✅ 支持安讯士(Axis)摄像头配置
- ✅ 支持通用RTSP摄像头
- ✅ 自动生成RTSP URL
- ✅ 测试摄像头连接
- ✅ 查看所有已配置设备

**使用方法 - 添加安讯士摄像头：**
1. 打开AI视觉检测（http://localhost:8503）
2. 选择「📹 摄像头管理」→「📹 摄像头配置」
3. 选择「安讯士(Axis)」
4. 填写信息：
   - 摄像头名称：A区门禁摄像头
   - IP地址：192.168.1.100
   - 用户名：admin
   - 密码：******
   - 端口：80（默认）
   - 位置：A区入口
5. 点击「添加摄像头」
6. 系统自动生成RTSP URL

**使用方法 - 添加通用RTSP摄像头：**
1. 选择「通用RTSP摄像头」
2. 填写摄像头名称
3. 输入完整RTSP URL：`rtsp://username:password@192.168.1.101:554/stream`
4. 填写位置信息
5. 添加完成

---

### 5. 📼 ExacqVision录像系统集成

**新增功能：**
- ✅ 配置ExacqVision服务器
- ✅ 访问历史录像（API调用）
- ✅ 导出录像片段
- ✅ 直接用于AI分析

**使用方法：**
1. 打开AI视觉检测（http://localhost:8503）
2. 选择「📹 摄像头管理」→「📼 ExacqVision服务器」
3. 填写服务器信息：
   - 服务器名称：主录像服务器
   - 服务器IP：192.168.1.200
   - 端口：80
   - 用户名：admin
   - 密码：******
4. 点击「添加服务器」

**接入录像的步骤：**
```
1. 配置ExacqVision服务器（如上）
2. 在「视频分析」中选择「从录像系统获取」
3. 选择摄像头、时间段
4. 系统自动下载录像
5. 开始AI分析
```

**注意事项：**
- ExacqVision API因版本而异，可能需要根据实际版本调整
- 当前代码提供了基础框架，可根据您的ExacqVision版本定制
- 建议先测试API连接，确认可用性

---

### 6. 📊 测试数据生成

**新增功能：**
- ✅ 一键生成所有模块的测试数据
- ✅ 包括报警、设备、知识库、用户问答、AI视觉数据

**已生成的测试数据：**
- 📊 611条报警数据（30天）
- 🔧 1840条设备日志（1个月）
- 📚 8条知识库条目（含PDF、Power BI链接示例）
- 💬 8条用户问答记录
- 👁️ 50条AI视觉检测记录

**重新生成测试数据：**
```bash
cd /Users/sven/Cursor_Project/RMC_Digital
source venv/bin/activate
python scripts/generate_test_data.py
```

---

## 🚀 完整功能列表

### 主Dashboard (端口8501)
- 🏠 KPI监控
- 📊 报警趋势分析
- 🎯 AI风险评估
- 🔧 设备管理
- 📚 知识库问答
- 🚫 屏蔽申请

### 知识库管理 (端口8502)
- ✏️ 添加知识（文本/文件/链接/Power BI）
- 🔍 搜索管理
- 💬 用户问答分析
- 🎯 待审核知识
- 📊 统计分析

### AI视觉检测 (端口8503)
- 📸 训练数据管理（图片+视频）
- 🎯 自定义行为类型
- 📹 摄像头配置（Axis + RTSP）
- 📼 ExacqVision集成
- 🎬 视频分析
- 🚨 实时告警
- 📊 统计分析

---

## 📝 使用流程示例

### 场景1: 识别"走廊奔跑"行为

**步骤1: 添加自定义行为类型**
```
1. 打开 http://localhost:8503
2. 点击「🎯 自定义行为类型」
3. 填写：
   - 行为代码：running_in_corridor
   - 行为名称：走廊奔跑
   - 描述：在走廊区域奔跑
   - 告警级别：中
4. 点击「添加行为类型」
```

**步骤2: 上传训练视频**
```
1. 点击「📸 训练数据管理」→「🎬 上传视频」
2. 选择行为类型：走廊奔跑
3. 调整帧率：2帧/秒
4. 上传3-5个奔跑行为的视频（每个5-15秒）
5. 系统自动提取100-200帧图片
```

**步骤3: 分析新视频**
```
1. 点击「🎬 视频分析」
2. 上传待检测的监控视频
3. 系统自动识别"走廊奔跑"行为
4. 检测到异常时发送告警
```

---

### 场景2: 接入现有摄像头实时监控

**步骤1: 配置摄像头**
```
1. 打开 http://localhost:8503
2. 点击「📹 摄像头管理」
3. 选择摄像头类型（Axis 或 RTSP）
4. 填写IP、用户名、密码
5. 测试连接
```

**步骤2: 开始实时监控**
```
1. 点击「🎬 视频分析」
2. 选择「摄像头实时分析」
3. 选择已配置的摄像头
4. 点击「启动实时监控」
5. 系统持续分析，检测异常行为
```

---

### 场景3: 分析ExacqVision历史录像

**步骤1: 配置ExacqVision**
```
1. 打开 http://localhost:8503
2. 点击「📹 摄像头管理」→「📼 ExacqVision服务器」
3. 填写服务器信息
4. 添加服务器
```

**步骤2: 获取并分析录像**
```
1. 点击「🎬 视频分析」
2. 选择「从ExacqVision获取」
3. 选择摄像头、时间段
4. 下载录像片段
5. 开始AI分析
```

---

## 🎯 最佳实践

### 训练数据建议

**图片训练数据：**
- 适用于静态行为（如抵门、强行拉门瞬间）
- 每种行为50+张
- 多角度、多光照条件

**视频训练数据：**
- 适用于动态行为（如尾随、徘徊、奔跑）
- 每种行为3-5个视频
- 每个视频5-30秒
- 包含完整动作过程
- 推荐帧率：2-5帧/秒

### 摄像头配置建议

**安讯士(Axis)摄像头：**
- 使用ONVIF协议更通用
- 默认RTSP端口554
- HTTP端口80
- 建议启用H.264编码

**通用RTSP摄像头：**
- 格式：`rtsp://用户名:密码@IP:端口/stream路径`
- 常见端口：554、8554
- 测试工具：VLC播放器

---

## 📌 常见问题

### Q1: 视频提取帧数如何选择？
**答**: 
- 快速动作（奔跑、翻越）：5-10帧/秒
- 中速动作（尾随、徘徊）：2-5帧/秒  
- 慢速动作（抵门、等待）：1-2帧/秒

### Q2: 如何提高识别准确率？
**答**:
1. 增加训练数据量（每类100+帧）
2. 使用视频而非单张图片
3. 多场景、多光照条件
4. 调整告警阈值

### Q3: ExacqVision API无法连接？
**答**:
- 检查IP和端口是否正确
- 确认防火墙设置
- 验证用户名密码
- 参考ExacqVision版本的API文档

### Q4: 自定义行为类型不生效？
**答**:
- 确认已上传该类型的训练数据
- 检查训练数据数量（建议50+帧）
- 重新启动AI视觉检测系统

---

## 🔄 启动所有服务

```bash
# 终端1: 后端API
cd /Users/sven/Cursor_Project/RMC_Digital
source venv/bin/activate
python app/main.py

# 终端2: 主Dashboard
source venv/bin/activate
streamlit run app/dashboard.py --server.port=8501

# 终端3: 知识库管理
source venv/bin/activate
streamlit run app/admin_panel.py --server.port=8502

# 终端4: AI视觉检测
source venv/bin/activate
streamlit run app/vision_ai_panel.py --server.port=8503
```

或使用快捷脚本：
```bash
./START_FREE.sh              # 启动主系统
./启动管理后台.sh            # 启动知识库管理
./启动AI视觉检测.sh          # 启动AI视觉检测
```

---

## 📊 访问地址

| 系统 | 地址 | 功能 |
|------|------|------|
| 后端API | http://localhost:8000 | REST API |
| API文档 | http://localhost:8000/docs | Swagger |
| 主Dashboard | http://localhost:8501 | 运营监控 |
| 知识库管理 | http://localhost:8502 | 内容管理 |
| AI视觉检测 | http://localhost:8503 | 视频分析 |

---

**🎉 现在您拥有一个功能完整、支持自定义、集成录像系统的智能安防平台！**

