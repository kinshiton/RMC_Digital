# CrewAI 工作流程详解

## 1. 代理协作概述

本系统使用CrewAI框架实现9个专业化代理的协作，每个代理负责特定的安防运营任务。代理之间通过任务委托、结果共享和协同决策实现智能化自动化。

## 2. 核心工作流程图

### 2.1 每日自动化运营流程

```
┌─────────────────────────────────────────────────────────────┐
│  定时触发器 (Cron: 每日01:00)                                 │
└────────────────────┬────────────────────────────────────────┘
                     │
         ┌───────────┴───────────┐
         │  Crew启动: Daily Ops  │
         └───────────┬───────────┘
                     │
         ┌───────────┴──────────────────────────────┐
         │                                           │
         ▼                                           ▼
┌─────────────────┐                        ┌─────────────────┐
│ 报警分析代理     │                        │ 设备监控代理     │
│ AlarmAnalyst    │                        │ DeviceMonitor   │
└────────┬────────┘                        └────────┬────────┘
         │                                           │
         │ 1. 加载CSV数据                             │ 1. 扫描设备日志
         │ 2. 统计分析                                │ 2. 计算健康评分
         │ 3. 生成图表                                │ 3. 识别异常模式
         │ 4. 阈值检查                                │ 4. 备件库存检查
         │                                           │
         ▼                                           ▼
    ┌─────────┐                              ┌──────────────┐
    │ 结果判断 │                              │  健康评估     │
    └────┬────┘                              └──────┬───────┘
         │                                           │
    超阈值？                                    故障设备？
         │                                           │
    ┌────┴────┐                              ┌──────┴───────┐
    │   是    │                              │     是       │
    └────┬────┘                              └──────┬───────┘
         │                                           │
         └───────────┬───────────┬───────────────────┘
                     │           │
                     ▼           ▼
            ┌──────────────────────────┐
            │   响应协调代理             │
            │   ResponseCoordinator    │
            └────────┬─────────────────┘
                     │
         ┌───────────┼───────────┐
         │           │           │
         ▼           ▼           ▼
   ┌─────────┐ ┌─────────┐ ┌─────────┐
   │ Teams   │ │  Email  │ │ 记录    │
   │ 通知    │ │  通知   │ │ 日志    │
   └─────────┘ └─────────┘ └─────────┘
                     │
                     ▼
            ┌─────────────────┐
            │  生成日报摘要    │
            └─────────────────┘
```

### 2.2 事件响应工作流

```
┌─────────────────────────────────────────────────────────────┐
│  触发: 新报警事件                                             │
│  来源: 用户输入 / API调用 / 自动检测                          │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
         ┌───────────────────────┐
         │   风险评估代理         │
         │   RiskAssessor        │
         └───────────┬───────────┘
                     │
                     │ 1. 关键词提取
                     │ 2. Azure AI情感分析
                     │ 3. 时间/地点因素
                     │ 4. 历史数据对比
                     │
                     ▼
            ┌─────────────────┐
            │  风险等级判定    │
            │  1-10分评分     │
            └────┬────────────┘
                 │
     ┌───────────┼───────────┐
     │           │           │
     ▼           ▼           ▼
┌────────┐  ┌────────┐  ┌────────┐
│ 高风险  │  │ 中风险 │  │ 低风险 │
│ ≥7分   │  │ 4-6分  │  │ <4分   │
└───┬────┘  └───┬────┘  └───┬────┘
    │           │           │
    │ P1优先级  │ P2优先级  │ P3优先级
    │ 5分钟响应 │ 15分钟    │ 60分钟
    │           │           │
    └───────────┼───────────┘
                │
                ▼
       ┌─────────────────┐
       │ 生成调查模板     │
       └────────┬────────┘
                │
                │ 包含:
                │ - 案件编号
                │ - 必填字段
                │ - 建议措施
                │ - 升级指南
                │
                ▼
       ┌─────────────────┐
       │ 知识库代理查询   │
       │ (相关政策/流程)  │
       └────────┬────────┘
                │
                ▼
       ┌─────────────────┐
       │ 响应协调代理     │
       │ - 通知相关人员   │
       │ - 分配任务       │
       │ - 跟踪响应时间   │
       └─────────────────┘
```

### 2.3 设备维护预测流程

```
┌─────────────────────────────────────────────────────────────┐
│  触发: 每小时定时 / 设备异常检测                              │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
         ┌───────────────────────┐
         │   设备监控代理         │
         │   DeviceMonitor       │
         └───────────┬───────────┘
                     │
                     │ 分析设备数据:
                     │ - 在线时间占比
                     │ - 错误率趋势
                     │ - 响应时间变化
                     │ - 维护历史
                     │
                     ▼
            ┌─────────────────┐
            │ 计算健康评分     │
            │ 0-100分          │
            └────┬────────────┘
                 │
     ┌───────────┼───────────┬───────────┐
     │           │           │           │
     ▼           ▼           ▼           ▼
┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐
│ 严重    │  │  差    │  │  一般  │  │  优秀  │
│ <30分  │  │ 30-50  │  │ 50-85  │  │ >85分  │
└───┬────┘  └───┬────┘  └───┬────┘  └───┬────┘
    │           │           │           │
    │ 立即维护  │ 计划维护  │ 正常监控  │ 继续监控
    │           │           │           │
    └───────────┴───────────┘           │
                │                       │
                ▼                       ▼
       ┌─────────────────┐     ┌─────────────┐
       │ 维护调度代理     │     │  无需行动   │
       │MaintenanceScheduler│  └─────────────┘
       └────────┬────────┘
                │
                │ 1. 优先级排序
                │ 2. 资源评估
                │ 3. 时间优化
                │ 4. 备件检查
                │
                ▼
       ┌─────────────────┐
       │ 生成维护计划     │
       │ - 设备列表       │
       │ - 维护动作       │
       │ - 预计工时       │
       │ - 所需备件       │
       └────────┬────────┘
                │
                ▼
       ┌─────────────────┐
       │ 备件库存检查     │
       │ (不足则发警报)   │
       └────────┬────────┘
                │
                ▼
       ┌─────────────────┐
       │ 响应协调代理     │
       │ - 通知维护团队   │
       │ - 创建工单       │
       └─────────────────┘
```

### 2.4 视觉异常检测流程

```
┌─────────────────────────────────────────────────────────────┐
│  触发: ExacqVision截图导入                                    │
│  频率: 运动检测触发 / 每小时定时                              │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
         ┌───────────────────────┐
         │   视觉检测代理         │
         │   VisionDetector      │
         └───────────┬───────────┘
                     │
         ┌───────────┴───────────┐
         │                       │
         ▼                       ▼
┌─────────────────┐      ┌─────────────────┐
│ OpenCV本地处理   │      │ Azure Vision    │
│ - 运动检测       │      │ - 对象识别      │
│ - 轮廓提取       │      │ - 人员检测      │
│ - 差分计算       │      │ - 场景描述      │
└────────┬────────┘      └────────┬────────┘
         │                       │
         └───────────┬───────────┘
                     │
                     ▼
            ┌─────────────────┐
            │  风险综合评估    │
            │                 │
            │ 因素:           │
            │ - 运动强度      │
            │ - 人员数量      │
            │ - 时间段        │
            │ - 区域重要性    │
            │ - 可疑物品      │
            └────┬────────────┘
                 │
                 ▼
            ┌─────────────────┐
            │  风险评分        │
            │  1-10分          │
            └────┬────────────┘
                 │
     ┌───────────┼───────────┐
     │           │           │
     ▼           ▼           ▼
┌────────┐  ┌────────┐  ┌────────┐
│ 高风险  │  │ 中风险 │  │ 低风险 │
│ ≥7分   │  │ 4-6分  │  │ <4分   │
└───┬────┘  └───┬────┘  └───┬────┘
    │           │           │
    │ 立即复核  │ 标记待查  │ 记录
    │           │           │
    └───────────┴───────────┘
                │
                ▼
       ┌─────────────────┐
       │ 生成标注图像     │
       │ (框出异常区域)   │
       └────────┬────────┘
                │
                ▼
       ┌─────────────────┐
       │ 响应协调代理     │
       │ (高风险自动通知) │
       └─────────────────┘
```

## 3. 代理间通信机制

### 3.1 委托模式

代理可以委托其他代理执行专业任务：

```python
# 报警分析代理发现异常，委托响应协调代理
class AlarmAnalystAgent:
    def analyze(self):
        # ... 分析逻辑
        if alarm_count > threshold:
            # 委托响应协调代理发送通知
            self.delegate(
                agent=response_coordinator,
                task="发送高报警率通知",
                context={"count": alarm_count, "threshold": threshold}
            )
```

### 3.2 上下文共享

代理间通过共享上下文传递信息：

```python
# Crew任务编排
crew = Crew(
    agents=[alarm_analyst, response_coordinator],
    tasks=[analyze_task, notify_task],
    process=Process.sequential,  # 顺序执行，共享上下文
    memory=True  # 启用记忆功能
)
```

### 3.3 结果聚合

多代理并行工作，结果由Crew聚合：

```python
# 并行执行多个分析任务
crew = Crew(
    agents=[alarm_analyst, vision_detector, device_monitor],
    tasks=[alarm_task, vision_task, device_task],
    process=Process.parallel,  # 并行执行
    verbose=True
)

result = crew.kickoff()
# result包含所有代理的输出
```

## 4. 任务优先级与调度

### 4.1 优先级定义

| 优先级 | 触发条件 | 响应时间 | 代理配置 |
|--------|---------|---------|---------|
| P1 (紧急) | 高风险事件、设备严重故障 | 5分钟 | `max_iter=10, allow_delegation=True` |
| P2 (重要) | 中风险事件、设备异常 | 15分钟 | `max_iter=5, allow_delegation=True` |
| P3 (普通) | 低风险事件、例行分析 | 60分钟 | `max_iter=3, allow_delegation=False` |
| P4 (批处理) | 定时任务、报告生成 | 按计划 | `max_iter=5, verbose=False` |

### 4.2 任务调度策略

```python
# 根据优先级动态调整代理配置
def create_incident_crew(priority: int):
    if priority == 1:
        # 高优先级：增加资源
        agents = [
            risk_assessor(max_iter=10),
            response_coordinator(max_iter=10),
            knowledge_agent(max_iter=5)
        ]
        process = Process.sequential
    else:
        # 低优先级：减少资源
        agents = [risk_assessor(max_iter=3)]
        process = Process.sequential
    
    return Crew(agents=agents, process=process)
```

## 5. 错误处理与重试

### 5.1 代理级错误处理

```python
class AlarmAnalystAgent(Agent):
    def _run(self, *args, **kwargs):
        try:
            return self.analyze_alarms(*args, **kwargs)
        except Exception as e:
            # 记录错误
            logger.error(f"报警分析失败: {e}")
            # 返回降级结果
            return {"status": "error", "message": str(e)}
```

### 5.2 Crew级重试机制

```python
def execute_with_retry(crew, max_retries=3):
    for attempt in range(max_retries):
        try:
            result = crew.kickoff()
            return result
        except Exception as e:
            logger.warning(f"Crew执行失败 (尝试 {attempt+1}/{max_retries}): {e}")
            if attempt == max_retries - 1:
                raise
            time.sleep(2 ** attempt)  # 指数退避
```

## 6. 性能优化策略

### 6.1 并行化

```python
# 独立任务并行执行
daily_crew = Crew(
    agents=[alarm_analyst, vision_detector, device_monitor],
    tasks=[alarm_task, vision_task, device_task],
    process=Process.parallel  # 并行执行，提升速度
)
```

### 6.2 缓存机制

```python
# 启用代理记忆，避免重复分析
agent = Agent(
    ...
    memory=True,  # 启用记忆
    cache=True    # 启用缓存
)
```

### 6.3 资源限制

```python
# 限制代理迭代次数，避免超时
agent = Agent(
    ...
    max_iter=5,              # 最多5次迭代
    max_execution_time=300   # 5分钟超时
)
```

## 7. 监控与日志

### 7.1 代理执行日志

```python
# 启用详细日志
agent = Agent(..., verbose=True)

# 输出示例:
# [AlarmAnalyst] 开始分析2025-10-28的报警数据
# [AlarmAnalyst] 加载了245条报警记录
# [AlarmAnalyst] 检测到高报警率: 102次 > 100次阈值
# [AlarmAnalyst] 委托ResponseCoordinator发送通知
# [ResponseCoordinator] 通知已发送至Teams频道
```

### 7.2 性能指标

跟踪关键指标：
- **任务完成时间**：每个代理任务的执行时间
- **委托次数**：代理间委托的频率
- **错误率**：任务失败的比例
- **资源使用**：CPU、内存占用

## 8. 扩展新代理

添加新代理的步骤：

```python
# 1. 定义代理
class NewSecurityAgent(Agent):
    role = '新代理角色'
    goal = '代理目标'
    backstory = '背景故事'
    tools = [CustomTool()]

# 2. 定义任务
def new_task(agent):
    return Task(
        description="任务描述",
        agent=agent,
        expected_output="期望输出"
    )

# 3. 集成到Crew
def extended_crew():
    new_agent = NewSecurityAgent()
    return Crew(
        agents=[..., new_agent],
        tasks=[..., new_task(new_agent)]
    )
```

---

**文档版本**: 1.0  
**最后更新**: 2025-10-28  
**维护者**: 安防运营团队

